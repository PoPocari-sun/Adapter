<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>BabeChat â†’ Tistory ë³€í™˜ê¸° (ìµœì¢…ë³¸)</title>
<style>
/* ===== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
body{
  font-family:Pretendard, 'Noto Sans KR',sans-serif;
  background:#fafafa;
  padding:24px;
  color:#111;
}
.app{
  max-width:980px;
  margin:0 auto;
  background:#fff;
  border-radius:12px;
  padding:20px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
/* í…ìŠ¤íŠ¸ ì…ë ¥ ë° ì¶œë ¥ ì˜ì—­ */
textarea{
  width:100%;
  min-height:180px;
  padding:12px;
  border-radius:8px;
  border:1px solid #ddd;
  font-family:monospace;
  resize:vertical;
}
input[type="text"]{
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  background:#B56576;
  color:#fff;
  border:0;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.small{font-size:0.9rem;margin-left:8px;color:#666}
.notice{color:#2a7a2a;display:none;margin-top:10px}
</style>
</head>

<body>
<div class="app">
  <h2>ğŸ’¬ BabeChat â†’ Tistory HTML ë³€í™˜ê¸° (ìµœì¢…)</h2>
  <p>ì‚¬ìš©ë²•: ìœ ì € ì´ë¦„ ì…ë ¥ â†’ TXT ë¶™ì—¬ë„£ê¸° or íŒŒì¼ ì—…ë¡œë“œ â†’ ë³€í™˜ â†’ ë³µì‚¬ â†’ í‹°ìŠ¤í† ë¦¬ HTML ëª¨ë“œì— ë¶™ì—¬ë„£ê¸°</p>

  <!-- ì…ë ¥ì°½ ë° ë²„íŠ¼ ì˜ì—­ -->
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
    <label style="font-weight:600">ìœ ì € ì´ë¦„</label>
    <input id="userName" type="text" placeholder="ì˜ˆ: ë‚˜ ë˜ëŠ” í”Œë ˆì´ì–´" style="width:220px" />
    <input id="file" type="file" accept=".txt" />
    <button id="loadSample">ìƒ˜í”Œì‚½ì…</button>
    <button id="convert">ë³€í™˜</button>
    <button id="copyBtn">ë³µì‚¬ (í´ë¦½ë³´ë“œ)</button>
    <span class="notice" id="copyNotice">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…</span>
  </div>

  <!-- ì…ë ¥ TXT -->
  <label style="font-weight:600">ì›ë³¸ TXT</label>
  <textarea id="txt" placeholder="BabeChat TXT ë‚´ìš©ì„ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ ì—…ë¡œë“œí•˜ì„¸ìš”."></textarea>

  <!-- ë¯¸ë¦¬ë³´ê¸° -->
  <h3 style="margin-top:16px">ë¯¸ë¦¬ë³´ê¸° (í‹°ìŠ¤í† ë¦¬ì— ë¶™ì—¬ë„£ì„ HTML)</h3>
  <div id="previewWrap" style="background:#fbfbfb;border:1px dashed #eee;padding:12px;border-radius:8px;min-height:120px"></div>

  <!-- ìµœì¢… HTML -->
  <h3 style="margin-top:16px">ìƒì„±ëœ HTML (í‹°ìŠ¤í† ë¦¬ HTML ëª¨ë“œì— ë¶™ì—¬ë„£ê¸°)</h3>
  <textarea id="outHtml" style="min-height:160px"></textarea>
</div>
<script>
/* ===================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ===================== */
function escapeHtml(s){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}
function removeImageFilenames(s){
  return s
    .replace(/\b[\w-]+\.(?:png|jpe?g|webp|gif)\b/gi,'')
    .replace(/^\s*img:\S+\s*$/gmi,'');
}
function removeLeadingDatetime(s){
  return s.replace(/^\s*\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.\s*[^,]*,\s*/,'');

}
const patternBabe = /^(\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.\s*[^,]+?),\s*(.+?)\s*:\s*(.*)$/;
const patternSimple = /^(.+?)\s*:\s*(.*)$/;

// ------- Markdown í…Œì´ë¸” â†’ HTML ë³€í™˜ í•¨ìˆ˜ -------
function convertMarkdownTableToHtml(text){
  const lines = text.split('\n');
  let inTable = false;
  let html = [];
  let headerCells = [];

  for(let i = 0; i < lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue;

    if(line.startsWith('|') && line.endsWith('|')){
      const cells = line.slice(1, -1).split('|').map(c => c.trim());

      if(!inTable){
        html.push('<table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; width:100%; text-align:center;">');
        headerCells = cells;
        html.push('<thead><tr>' + cells.map(c => `<th>${escapeHtml(c)}</th>`).join('') + '</tr></thead><tbody>');
        inTable = true;
      } else {
        if(!/^[-:| ]+$/.test(line)){
        html.push('<tr>' + cells.map((c, idx) => {
            const align = headerCells[idx] && headerCells[idx].includes('(ê¸€ ì œëª©)') ? 'left' : 'center';
            return `<td style="text-align:${align}">${escapeHtml(c)}</td>`;
          }).join('') + '</tr>');
        }
      }

    } else {
      if(inTable){
        html.push('</tbody></table>');
        inTable = false;
      }
      html.push(line);
    }
  }

  if(inTable) html.push('</tbody></table>');

  return html.join('\n');
}

/* ==================== TXT íŒŒì‹± ==================== */
function autoCloseInfoBlocks(lines, userName){
  const newLines = [];
  let inInfo = false;

  for(let i=0; i<lines.length; i++){
    let line = lines[i];

    if(/^```INFO/.test(line)) {
      inInfo = true;
      newLines.push(line);
      continue;
    }

    if(inInfo){
      newLines.push(line);
      const nextLine = lines[i+1] || '';
      const m = nextLine.match(/^(\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.\s*[^,]+?),\s*(.+?)\s*:\s*(.*)$/);

      if(m && m[2].trim() === userName){
        if(line.trim() !== '```' && !line.trim().startsWith('[ëª¨ë“œ]:') && nextLine.trim() !== '```'){
          newLines.push('```');
        }
        inInfo = false;
      } else if(i === lines.length - 1){
        if(line.trim() !== '```' && !line.trim().startsWith('[ëª¨ë“œ]:')){
          newLines.push('```');
        }
        inInfo = false;
      }
      continue;
    }

    newLines.push(line);
  }
  return newLines;
}

function parseTxtToItems(raw){
  const lines = raw.replace(/\r/g,'').split('\n');
  const items = [];
  let inInfo = false;
  let infoBuf = [];
  let lastSender = null;
  let textBuffer = [];

  const flushBuffer = () => {
    if (lastSender && textBuffer.length > 0) {
      items.push({ type:'chat', sender:lastSender, text: textBuffer.join('\n') });
      textBuffer = [];
    }
  };

  for(let i = 0; i < lines.length; i++){
    let line = lines[i].trim();
    if(!line) continue;
    if(/^\s*img:\S+/i.test(line)) continue;

    if(/^```INFO/.test(line)){
      flushBuffer();
      inInfo = true;
      infoBuf = [];
      continue;
    }

    if(inInfo){
      if(line === '```' || /^\[ëª¨ë“œ\]:/.test(line)){
          flushBuffer();
          items.push({ type:'info', text: infoBuf.join('\n') });
          inInfo = false;
          infoBuf = [];
          continue;
        } else {
          infoBuf.push(line);
          continue;
        }
    }

    if(line.startsWith('|') && line.endsWith('|')){
      flushBuffer();
      let tableLines = [line];
      let j = i + 1;
      while(j < lines.length){
        const nextLine = lines[j].trim();
        if(nextLine.startsWith('|') && nextLine.endsWith('|')){
          tableLines.push(nextLine);
          j++;
        } else break;
      }
      items.push({ type:'chat', sender:lastSender, text: tableLines.join('\n') });
      i = j - 1;
      continue;
    } 

    let m = line.match(patternBabe);
    if(m){
      flushBuffer();
      lastSender = m[2].trim() || lastSender;
      textBuffer.push(m[3].trim());
      continue;
    }

    m = line.match(patternSimple);
    if(m){
      flushBuffer();
      lastSender = m[1].trim();
      textBuffer.push(m[2].trim());
      continue;
    }

    if(line === '```'){ continue; }

    if(lastSender){
      textBuffer.push(line);
    } else {
      flushBuffer();
      items.push({ type:'text', text: line });
    }
  }

  flushBuffer();
  return items;
}

/* ==================== HTML ìƒì„± ==================== */
function formatParagraph(text){
  const lines = text.split('\n');
  let inTable = false;
  const out = [];

  for(let line of lines){
    line = line.trim();
    if(!line) continue;

    if(line.startsWith('|') && line.endsWith('|')){
      inTable = true;
      out.push(line);
      continue;
    }

    if(inTable && !line.startsWith('|')){
      inTable = false;
    }

    if(/^[ê°€-í£A-Za-z0-9]+:\s*["â€œâ€]/.test(line)){
      out.push(`<p style="margin:5px 0; font-weight:600; color:#F6C177;">${line}</p>`);
    } else if(!inTable){
      out.push(`<p style="margin:4px 0;">${line}</p>`);
    } else {
      out.push(line);
    }
  }

  return out.join('\n');
}

function buildInlineHtml(items,userName){
  const out=[];  
  const wrapperStyle='font-family:Pretendard, Noto Sans KR, sans-serif; background:#181818; padding:12px;';
  out.push(`<div style="${wrapperStyle}">`);

  let botBuffer=[];

  const flushBotBuffer=()=>{ 
    if(botBuffer.length===0) return;
    let text = botBuffer.join('\n');
    text = formatParagraph(text);
    text = convertMarkdownTableToHtml(text);
    const bubbleStyle='padding:12px 14px;border-radius:14px;white-space:pre-wrap;word-break:break-word;line-height:1.6;max-width:82%;box-shadow:0 2px 6px rgba(0,0,0,0.45);background:#2b2b2b;color:#eaeaea;border-top-left-radius:0;';
    out.push(`<div style="display:flex;justify-content:flex-start;margin:10px 0;"><div class="bubbleText" style="${bubbleStyle}">${text}</div></div>`);
    botBuffer=[];
  };

  for(const it of items){
    if(it.type==='info'){
      flushBotBuffer();
      const inner=escapeHtml(removeImageFilenames(it.text));
      out.push(
        `<details open style="margin:10px 0;padding:10px 12px;background:#181818;border-radius:8px;border:1px solid #333;">`+
        `<summary style="font-weight:600;color:#ddd;cursor:pointer;">ğŸ“– ì¥ë©´ ì •ë³´</summary>`+
        `<pre style="white-space:pre-wrap;margin-top:8px;color:#ccc;font-family:inherit;background:#181818;padding:8px;border-radius:6px;">${inner}</pre>`+
        `</details>`
      );
      continue;
    }

    if(it.type==='text'){ botBuffer.push(it.text); continue; }

    if(it.type==='chat'){
      const isUser = ((userName && it.sender === userName) || /\*\(.*\)\*/.test(it.sender) || /\)\*$/.test(it.sender));
      if(isUser){
        flushBotBuffer();
        const senderHtml=`<div style="font-weight:700;font-size:0.95rem;margin-bottom:6px;color:#fff;">${escapeHtml(it.sender)}</div>`;
        const userBubbleStyle='padding:12px 14px;border-radius:14px;white-space:pre-wrap;word-break:break-word;line-height:1.6;max-width:82%;box-shadow:0 2px 6px rgba(0,0,0,0.45);background:#B56576;color:#fff;border-top-right-radius:0;';
        out.push(`<div style="display:flex;justify-content:flex-end;margin:10px 0;"><div class="bubbleText" style="${userBubbleStyle}">${senderHtml}${escapeHtml(it.text)}</div></div>`);
      } else {
        botBuffer.push(it.text);
      }
    }
  }

  flushBotBuffer();
  out.push(`</div>`);
  return out.join('\n');
}

/* ==================== UI ì´ë²¤íŠ¸ ==================== */
document.getElementById('loadSample').addEventListener('click',()=>{
  const sample=[
    `2025. 11. 8. ì˜¤í›„ 2:12, ë‚˜ : ì•ˆë…•í•˜ì„¸ìš”!`,
    `2025. 11. 8. ì˜¤í›„ 2:13, ë¦¬ë¹„ : "ë¦¬ë¹„: ë„¤, ë°˜ê°‘ìŠµë‹ˆë‹¤, ì£¼ì¸ë‹˜."`,
    `|êµ¬ë¶„|ê²Œì‹œíŒì¢…ë¥˜|ì œëª©(ëŒ“ê¸€ìˆ˜)|ê¸€ì“´ì´|ì¶”ì²œìˆ˜|`,
    `|:-:|:-:|:-|:-|:-:|`,
    `|ğŸ”¥|[ìë‘]|ìƒˆë¡œ ë“¤ì¸ ì™€ì¼ë“œ, ë„ˆë¬´ ê·€ì—½ì§€ ì•Šëƒ? (12)|ì½”ì½”ì•„|15|`,
    `|ğŸ”¥|[ìë‘]|ì•„í¬ê¸‰ ê²½í˜¸ì› ì•ë°œ(?) í›„ê¸° (21)|ã…‡ã…‡(112.15)|11|`,
    "```INFO",
    "ì¥ë©´: ì‹ë‹¹ ë‚´ë¶€",
    "ì‹œê°„: ì €ë…",
    "```"
  ].join('\n');
  document.getElementById('txt').value=sample;
  document.getElementById('previewWrap').innerHTML='';
  document.getElementById('outHtml').value='';
});

document.getElementById('file').addEventListener('change', (e)=>{
  const f=e.target.files&&e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    document.getElementById('txt').value=r.result||'';
    document.getElementById('previewWrap').innerHTML='';
    document.getElementById('outHtml').value='';
  };
  r.readAsText(f,'utf-8');
});

document.getElementById('copyBtn').addEventListener('click', async ()=>{
  const out=document.getElementById('outHtml').value||'';
  if(!out.trim()){ alert('ë¨¼ì € ë³€í™˜ì„ ëˆŒëŸ¬ HTMLì„ ìƒì„±í•˜ì„¸ìš”.'); return; }

  try{
    await navigator.clipboard.writeText(out);
    const n=document.getElementById('copyNotice');
    n.style.display='inline-block';
    setTimeout(()=>n.style.display='none',1400);
  }
  catch(err){
    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ì„¸ìš”.');
  }
});

/* ===== ë³€í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸ (ìƒë‹¨ ìŠ¤íƒ€ì¼ ìë™ ì‚½ì…) ===== */
document.getElementById('convert').addEventListener('click', ()=>{

  console.clear();
  console.log("ğŸ” ë³€í™˜ í”„ë¡œì„¸ìŠ¤ ë””ë²„ê·¸ ì‹œì‘");

  const raw = document.getElementById('txt').value||'';
  const userName = (document.getElementById('userName').value||'').trim();

  // INFO ìë™ ì¢…ë£Œ ì²˜ë¦¬
  let rawLines = raw.replace(/\r/g,'').split('\n');
  rawLines = autoCloseInfoBlocks(rawLines, userName);
  const processedRaw = rawLines.join('\n');

  // íŒŒì‹±
  const items = parseTxtToItems(processedRaw);

  // HTML ìƒì„±
  let finalHtml = buildInlineHtml(items, userName);

  // ======================== ìƒë‹¨ ìŠ¤íƒ€ì¼ ì‚½ì… ========================
  const styleCode = `<div>
<style>
  .bubbleText p {
    color: inherit;
  }
</style>
</div>\n`;
  finalHtml = styleCode + finalHtml;
  // =============================================================

  document.getElementById('previewWrap').innerHTML = finalHtml;
  document.getElementById('outHtml').value = finalHtml;
});
</script>

</body>
</html>
